<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOFHEL - Deshbord</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="css/geral.css">
    <link rel="stylesheet" href="css/deshbord.css">

</head>

<body style="overflow-y: scroll;">
    <div class="side-bar">
        <div class="nav">
            <img src="../deshbord/imagens-deshbord/logotipo01.png" alt="" style="width: 200px;">

            <p>Olá Fernanda Caramico, seja bem vindo(a)</p>

            <div class="nav-list">
                <div id="atual">
                    <a href="deshbord.html"><img src="../deshbord/imagens-deshbord/house.png" alt="icone">Inicio</a>
                </div>
                <div><a href="perfil.html"><img src="../deshbord/imagens-deshbord/person-circle.png"
                            alt="icone">Perfil</a>
                </div>
                <div><a href="funcionarios.html"><img src="../deshbord/imagens-deshbord/people.png"
                            alt="icone">Funcionarios</a>
                </div>
                <div><a href="armazens.html"><img src="../deshbord/imagens-deshbord/cube.png" alt="icone">Armazéns</a>
                </div>
                <div><a href="suporte-bob.html"><img src="../deshbord/imagens-deshbord/body.png"
                            alt="icone">Suporte-BobIA</a>
                </div>
                <div><a href="../inicio.html"><img src="../deshbord/imagens-deshbord/chevron-back-circle.png"
                            alt="icone">sair</a>
                </div>
            </div>
        </div>
    </div>
    <div class="main">
        <div class="header">
            <div class="topo">
                <div class="column-1">
                    <p id="title">Análise de dados - <span id="nome_empresa">Vinícola Dom
                            Aurélio</span></p>
                    <div class="sub">

                        <div class="column-1">
                            <select name="armazem" id="armazem_atual" onclick="trocar1()"">
                                <option value=" armazem1" ">Armazém1</option>
                                <option value=" geral">Geral</option>
                                <option value="armazem2">Armazém2</option>
                                <option value="armazem3">Armazém3</option>
                                <option value="armazem4">Armazém4</option>
                                <option value="armazem5">Armazém5</option>
                            </select>
                        </div>
                        <div class="column-2">
                            <input type="date" name="Atual" id="Atualdia">
                        </div>
                    </div>
                </div>
                <div class="column-2">
                    <div>
                        <img src="../deshbord/imagens-deshbord/person-circle.png" alt="picture"
                            style="padding-right: 10px;">
                        <p> Fernanda Caramico </p>
                        <img src="../deshbord/imagens-deshbord/notifications.png" alt="" id="icone_notificacoes"
                            onclick="abrir_notificacoes()">
                    </div>
                </div>
            </div>

        </div>
        <div class="card-topo">
            <div class="card pouco_texto" style="background-color: rgb(192, 113, 113);">
                <p>Temperatura Atual</p>
                <h2>12.8°C</h2>
            </div>
            <div class="card pouco_texto" style="background-color: rgb(231, 229, 123);">
                <p>Umidade Atual</p>
                <h2>43%</h2>
            </div>
            <div class="card pouco_texto" style="background-color: rgb(192, 113, 113);">
                <p>Alertas Ativos</p>
                <h2>2</h2>
            </div>
            <div class="card">
                <p>Quantidade de sensores</p><br>
                <h2>4</h2>
            </div>
            <div class="card">
                <p>Total de alertas na semana</p>
                <h2>5</h2>
            </div>
        </div>
        <!---->

        <div class="container">


            <div class="column-1">
                <div class="grafico pizza">
                    <h4>Tipos de Vinhos Sendo Monitorados (%)</h4>
                    <div id="contem_grafico_redondo">
                        <canvas id="porcentagem_tipos_vinhos" height="300"></canvas>
                    </div>
                </div>
                <div class="grafico donut">
                    <h4>Distribuição de Status dos Sensores (%)</h4>
                    <div id="contem_grafico_redondo">

                        <canvas id="status_sensores" height="350rem"> </canvas>
                    </div>
                </div>


            </div>
            <div class="column-2">
                <div class="grafico linha">
                    <h4>Variação na Temperatura nas Últimas 24h</h4>
                    <!--<span>Faixa ideal <input type="checkbox" name="temp_ideal" id="ipt_temp_ideal"></span>
                    <span>Faixa de alerta <input type="checkbox" name="temp_alerta" id="ipt_temp_alerta"></span>
                    <span>Faixa critica <input type="checkbox" name="temp_critica" id="ipt_temp_critica"></span>-->
                    <canvas id="variacao_temperatura_atual" height="89rem"></canvas>
                </div>
                <div class="grafico linha">
                    <h4>Variação na Umidade nas Últimas 24h</h4>
                    <canvas id="variacao_umidade_atual" height="89rem"></canvas>
                </div>
                <!--<div class="grafico barras">
                    <h4>Alertas Ativos Em Cada Armazém</h4>
                    <canvas id="ranking_grafico" height="112rem"></canvas>
                </div>
                <div class="grafico barras">
                    <canvas id="myChart"></canvas>
                </div>
                -->
            </div>

            <div class="column-3">

                <div class="card-parametros">
                    <div class="temperatura ">
                        <div class="critico parametro" style="background-color: rgb(192, 113, 113); color:rgb(0, 0, 0)">
                            <p>Temperatura - Critica</p>
                            <h2>13°C</h2>

                            <p>Umidade - Critica</p>
                            <h2>40%</h2>
                        </div>
                        <div class="alerta parametro" style="background-color: rgb(231, 229, 123); color: black;">
                            <p>Temperatura - Alerta</p>
                            <h2>15°C</h2>
                            <p class="pouco">Umidade - Alerta</p>
                            <h2>44%</h2>

                        </div>
                        <div class="ideal parametro" style="background-color: rgb(123, 231, 123); color: black;">
                            <p>Temperatura - Ideal</p>
                            <h2>18°C</h2>
                            <p class="pouco">Umidade - Ideal</p>
                            <h2>52.5%</h2>

                        </div>
                        <div class="alerta parametro" style="background-color: rgb(231, 229, 123); color: black;">
                            <p>Temperatura - Alerta</p>
                            <h2>21°C2</h2>
                            <p class="pouco">Umidade - Alerta</p>
                            <h2>61%</h2>

                        </div>
                        <div class="critico parametro" style="background-color: rgb(192, 113, 113); color:rgb(0, 0, 0)">
                            <p>Temperatura - Critica</p>
                            <h2>23°C</h2>
                            <p>Umidade - Critica</p>
                            <h2>65%</h2>

                        </div>
                    </div>
                    <!--
                    <div class="umidade ">
                        <div class="critico parametro">
                            <p>Umidade - Critica</p>
                            <h2>40%</h2>
        
                        </div>
                        <div class="alerta parametro ">
                            <p class="pouco">Umidade - Alerta</p>
                            <h2>44%</h2>
        
                        </div>
                        <div class="ideal parametro">
                            <p class="pouco">Umidade - Ideal</p>
                            <h2>52.5%</h2>
        
                        </div>
                        <div class="alerta parametro">
                            <p class="pouco">Umidade - Alerta</p>
                            <h2>61%</h2>
        
                        </div>
                        <div class="critico parametro">
                            <p>Umidade - Critica</p>
                            <h2>65%</h2>
        
                        </div>
                    </div>-->



                </div>
                <div class="notificacoes" id="notificacao_caixa" style="display: none; z-index: 10;">
                    <h4>Ultimas notificacoes <span><img src="../deshbord/imagens-deshbord/chevron-back-circle.png"
                                alt="" id="icone_fechar" onclick="fechar_notificacoes()"></span> </h4>
                    <div class="notificacao">
                        <img src="../deshbord/imagens-deshbord/notifications.png">
                        <p>Armazém 1 <br> <span>Temperatura acima do
                                recomendado</span></p>
                    </div>
                    <div class="notificacao">
                        <img src="../deshbord/imagens-deshbord/notifications.png">
                        <p>Armazém 2<br> <span>Temperatura acima do
                                recomendado</span></p>
                    </div>
                    <div class="notificacao concluida">
                        <img src="../deshbord/imagens-deshbord/notifications.png">
                        <p>Armazém 3 <br><span>Temperatura acima do
                                recomendado</span></p>
                    </div>
                    <div class="notificacao concluida">
                        <img src="../deshbord/imagens-deshbord/notifications.png">
                        <p>Armazém 4 <br><span>Temperatura acima do
                                recomendado</span></p>
                    </div>
                    <div class="notificacao concluida">
                        <img src="../deshbord/imagens-deshbord/notifications.png">
                        <p>Armazém 5 <br><span>Temperatura acima do
                                recomendado</span></p>
                    </div>
                </div>

            </div>


        </div>
    </div>
</body>

</html>
<script>
    // so colocando valor no input
    Atualdia.value = "2025-04-14"
    let proximaAtualizacao
    const fkArmazem = 1;


    function trocar1() {
        var select = armazem_atual.value
        if (select == 'geral') {
            window.location.href = "deshbord.html";

        }
        if (select == 'armazem3') {
            window.location.href = "deshbord-armazem3.html";

        }
    }


    var notificacao_aberta = false
    // abrir as notificaoes
    function abrir_notificacoes() {
        if (notificacao_aberta == false) {
            notificacao_caixa.style.display = "block";
            notificacao_aberta = true
        } else {
            notificacao_caixa.style = "display: none "
            notificacao_aberta = false

        }


    }
    function fechar_notificacoes() {
        notificacao_caixa.style = "display:none"
    }

    window.onload = obterDadosGrafico(fkArmazem);
    function obterDadosGrafico(fkArmazem) {


        if (proximaAtualizacao != undefined) {
            clearTimeout(proximaAtualizacao);
        }

        fetch(`/medidas/ultimas/${fkArmazem}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    //      resposta.reverse();

                    plotarGrafico(resposta, fkArmazem);

                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

    function plotarGrafico(resposta, fkArmazem) {

        const label_temperatura = []
        const data_var_temp = {
            labels: label_temperatura,
            datasets: [{
                label: 'Temperatura',
                data: [],
                fill: false,
                borderColor: '#551c36',
                backgroundColor: '#551c36',
                tension: 0.1
            },
            ]
        };
        for (let i = resposta.length - 1; i >= 0; i--) {
            var registro = resposta[i];
            label_temperatura.push(registro.dataHora);
            data_var_temp.datasets[0].data.push(registro.temperatura);
        }
        const config_var_temp = {
            type: 'line',
            data: data_var_temp,
        };
        const ctx_temp_atual = document.getElementById('variacao_temperatura_atual').getContext('2d');
        let GraficoTemperatura = new Chart(ctx_temp_atual, config_var_temp);

        const labels_umidade = []
        const data_var_umidade = {
            labels: labels_umidade,
            datasets: [{
                label: 'Umidade',
                data: [],
                fill: true,
                borderColor: 'rgba(240, 248, 255, 0)',
                backgroundColor: 'rgb(158, 73, 99',
                tension: 0.1
            },
            ]
        };
        for (let i = resposta.length - 1; i >= 0; i--) {
            var registro = resposta[i];
            labels_umidade.push(registro.dataHora);
            data_var_umidade.datasets[0].data.push(registro.umidade);
        }
        const config_var_umidade = {
            type: 'line',
            data: data_var_umidade,
        };

        const ctx_umidade_atual = document.getElementById('variacao_umidade_atual').getContext('2d');
        let GraficoUmidade = new Chart(ctx_umidade_atual, config_var_umidade);




        setTimeout(() => {
            atualizar_grafico_temperatura(fkArmazem, data_var_temp, GraficoTemperatura, data_var_umidade, GraficoUmidade)
        }, 2000);

    }
    function atualizar_grafico_temperatura(fkArmazem, data_var_temp, GraficoTemperatura, data_var_umidade, GraficoUmidade) {



        fetch(`/medidas/tempo-real/${fkArmazem}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (novoRegistro) {

                    //  obterdados(fkArmazem);
                    // alertar(novoRegistro, fkArmazem);
                    console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
                    console.log(`Dados atuais do gráfico:`);
                    console.log(data_var_temp);


                    if (novoRegistro[0].dataHora == data_var_temp.labels[data_var_temp.labels.length - 1]) {
                        console.log("---------------------------------------------------------------")
                        console.log("Como não há data_var_temp novos para captura, o gráfico não atualizará.")
                        console.log("Horário do novo dado capturado:")
                        console.log(novoRegistro[0].dataHora)
                        console.log("Horário do último dado capturado:")
                        console.log(data_var_temp.labels[data_var_temp.labels.length - 1])
                        console.log("---------------------------------------------------------------")
                    } else {
                        // tirando e colocando valores no gráfico
                        data_var_temp.labels.shift(); // apagar o primeiro
                        data_var_temp.labels.push(novoRegistro[0].dataHora); // incluir um novo momento

                        data_var_temp.datasets[0].data.shift();  // apagar o primeiro de temperatura
                        data_var_temp.datasets[0].data.push(novoRegistro[0].temperatura); // incluir uma nova medida de temperatura

                        GraficoTemperatura.update();

                        data_var_umidade.labels.shift(); // apagar o primeiro
                        data_var_umidade.labels.push(novoRegistro[0].dataHora); // incluir um novo momento

                        data_var_umidade.datasets[0].data.shift();  // apagar o primeiro de temperatura
                        data_var_umidade.datasets[0].data.push(novoRegistro[0].umidade); // incluir uma nova medida de temperatura

                        GraficoUmidade.update();


                    }

                    // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                    proximaAtualizacao = setTimeout(() => atualizar_grafico_temperatura(fkArmazem, data_var_temp, GraficoTemperatura, data_var_umidade, GraficoUmidade), 2000);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
                // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                proximaAtualizacao = setTimeout(() => atualizar_grafico_temperatura(fkArmazem, data_var_temp, GraficoTemperatura, data_var_umidade, GraficoUmidade), 2000);
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });

    }










    //graficos com chart js
    // grafico do tipo barra
    const ctx = document.getElementById('myChart');






    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho'],
            datasets: [{
                label: 'Temperatura Média',
                data: [22, 24, 27, 23, 20, 18],
                backgroundColor: [
                    'rgb(255, 140, 0)',
                    'rgb(255, 140, 0)',
                    'rgb(255, 140, 0)',
                    'rgb(255, 140, 0)',
                    'rgb(255, 140, 0)',
                    'rgb(255, 140, 0)'
                ],
                borderWidth: 1
            },
            {
                label: 'Umidade Média',
                data: [90, 89, 93, 87, 88, 82],
                backgroundColor: [
                    'rgb(0, 102, 255)',
                    'rgb(0, 102, 255)',
                    'rgb(0, 102, 255)',
                    'rgb(0, 102, 255)',
                    'rgb(0, 102, 255)',
                    'rgb(0, 102, 255)'
                ],
                borderWidth: 1
            }
            ],
        },
    });

    // grafico do tipo pizza 

    /*Primero declaramos a data e depois criamos o grafico usando algo parecido a um procedimento e depois plotamos no html*/
    const data_pizza = {
        labels: [
            'Tinto Medio',
            'Tinto Espumante',
            'Fortificado'
        ],
        datasets: [{
            label: 'Tipo de vinho (%)',
            data: [60, 20, 20],

            backgroundColor: [
                'rgb(158, 73, 99)', // Vermelho 
                'rgb(189, 115, 137)',  // Amarelo 
                '#4c1130', // Verde 

            ],
            hoverOffset: 5
        }]
    };
    const pizza = {
        type: 'pie',
        data: data_pizza,
        // usando options para colocar a legenda embaixo do grafico
        options: {
            plugins: {
                legend: {
                    position: 'bottom', // Coloca a legenda embaixo do gráfico
                    labels: {
                        color: 'black', // Cor da fonte da legenda
                        font: {
                            size: 14
                        }
                    }
                },
            }
        }

    };
    const myChart_pizza = document.getElementById('porcentagem_tipos_vinhos');
    new Chart(myChart_pizza, pizza);

    // grafico de donunts -------------------------------------------------------------

    const data_status_sensores = {
        labels: [
            'Ativo',
            'Inativo',
            'Em manutenção'
        ],
        datasets: [{
            label: 'status',
            data: [10, 0, 0],
            backgroundColor: [
                'rgb(158, 73, 99)', // Vermelho 
                'rgb(189, 115, 137)',  // Amarelo 
                '#4c1130', // Verde 
            ],
            hoverOffset: 3
        }]
    };
    const donunts = {
        type: 'doughnut',
        data: data_status_sensores,
        options: {
            plugins: {
                legend: {
                    position: 'bottom', // Coloca a legenda embaixo do gráfico
                    labels: {
                        color: 'black', // Cor da fonte da legenda
                        font: {
                            size: 14
                        }
                    }
                },
            }
        }
    };
    const myChart_donuts = document.getElementById('status_sensores');
    new Chart(myChart_donuts, donunts);

    // grafico de ranking de alertas ativos por armazem -------------------------------------------------------------
    // grafico do tipo linha-------------------------------------------------------------












    // grafico do tipo linha-------------------------------------------------------------


    /// grafico barra tipos de alertas

    const tipos_alerta = document.getElementById('tipos_alerta');

    new Chart(tipos_alerta, {
        type: 'bar',
        data: {
            labels: ['Temperatura alta', 'Temperatura Baixa', 'Umidade Alta', 'Umidade Baixa', 'Falha de equipamento'],
            datasets: [{
                label: 'Tipo de alerta',
                data: [0, 4, 0, 1, 1],
                backgroundColor: [
                    'rgb(255, 140, 0)',
                    'blue',
                    'rgb(255, 140, 0)',
                    'blue',
                    'grey',
                ],
                borderWidth: 1
            }
            ],
        },
    });

</script>