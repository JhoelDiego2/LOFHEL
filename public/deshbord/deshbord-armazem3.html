<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOFHEL - Deshbord</title>
    <link rel="stylesheet" href="css/geral.css">
    <link rel="stylesheet" href="css/deshbord.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="../js/sessao.js"></script>
</head>

<body onload="validarSesao(), buscarArmazens()">
    <div class="side-bar">
        <div class="nav">
            <img src="../deshbord/imagens-deshbord/logotipo01.png" alt="" style="width: 200px;">

            <p>Olá, <span class="b_usuario">Fernanda Caramico </span>, seja bem vindo(a)
                <span id="b_cargo"></span>
            </p>

            <div class="nav-list">
                <div id="atual">
                    <a href="deshbord.html"><img src="../deshbord/imagens-deshbord/house.png" alt="icone">Inicio</a>
                </div>
                <div><a href="perfil.html"><img src="../deshbord/imagens-deshbord/person-circle.png"
                            alt="icone">Perfil</a>
                </div>
                <div><a href="funcionarios.html"><img src="../deshbord/imagens-deshbord/people.png"
                            alt="icone">Funcionarios</a>
                </div>
                <div><a href="armazens.html"><img src="../deshbord/imagens-deshbord/cube.png" alt="icone">Armazéns</a>
                </div>
                <div><a href="https://lofhel.atlassian.net/servicedesk/customer/portal/2" target="_blank"><img src="../deshbord/imagens-deshbord/body.png"
                            alt="icone">Suporte</a>
                </div>
                <div><a href="../inicio.html"><img src="../deshbord/imagens-deshbord/chevron-back-circle.png"
                            alt="icone">sair</a>
                </div>
            </div>
        </div>
    </div>
    <div class="main">
        <div class="header">
            <div class="topo">
                <div class="column-1">
                    <p id="title">Análise de dados - <span id="b_nome_fantasia">Vinícola Dom
                            Aurélio</span></p>
                    <div class="sub">

                        <div class="column-1">
                            <select name="armazem" id="armazem_atual" onclick="trocar1()"">
                                <option value=" armazem3">Armazém3</option>
                                <option value="geral">Geral</option>
                                <option value="armazem1" ">Armazém1</option>
                                <option value=" armazem2">Armazém2</option>
                                <option value="armazem3">Armazém4</option>
                                <option value="armazem3">Armazém5</option>
                            </select>
                        </div>

                    </div>
                </div>
                <div class="column-2">
                    <div>
                        <p class="b_usuario"> Fernanda Caramico </p>
                        <img src="../deshbord/imagens-deshbord/notifications.png" alt="" id="icone_notificacoes"
                            onclick="abrir_notificacoes()">
                    </div>
                </div>
            </div>

        </div>
        <div class="card-topo">
            <div class="card pouco_texto">
                <p class="titulo_card">Temperatura Atual</p>
                <p class="texto_card" id="b_temperatura_atual">2°C</p>
            </div>
            <div class="card pouco_texto">
                <p class="titulo_card">Umidade Atual</p>
                <p class="texto_card" id="b_umidade_atual">50%</p>
            </div>
            <div class="card pouco_texto">
                <p class="titulo_card">Alertas hoje</p>
                <p class="texto_card">1</p>
            </div>
            <div class="card">
                <p class="titulo_card">Alerta mais frequente</p>
                <p class="texto_card">Critico</p>
            </div>
            <div class="card">
                <p class="titulo_card">Total de alertas na semana</p>
                <p class="texto_card">3</p>
            </div>
        </div>

        <div class="container">

            <div class="column-1">
                <div class="grafico donut">
                    <h4 class="titulo_card titulo_desh">Distribuição de Status dos Sensores (%)</h4>
                    <canvas id="status_sensores" style="width: 20vw; height: 7vh;"> </canvas>
                </div>
                <div class="container-notification-history">
                    <div class="info-history">
                        <p style="text-align: center; width: 100%;">Legenda Parametros</p>
                    </div>
                    <div class="container-history">
                        <div class="history">
                            <img src="imagens-deshbord/alert-critico.png" alt="">
                            <div class="data-history">
                                <p class="titulo_params">Alerta Crítico</p>
                                <p> Temperatura:
                                    < 10 °C ou> 20 °C
                                </p>
                                <p> Umidade:
                                    < 55% ou> 75%
                                </p>
                            </div>
                        </div>

                        <div class="history">
                            <img src="https://cdn-icons-png.flaticon.com/512/257/257195.png" alt="">
                            <div class="data-history">
                                <p class="titulo_params">Atenção</p>
                                <p>Temperatura: 
                                < 11.5 °C ou> 16.5 °C</p>
                                <p> Umidade:
                                < 58% ou> 72%</p>
                            </div>
                        </div>

                        <div class="history">
                            <img src="https://img.freepik.com/vetores-premium/icone-de-avisos-de-notificacao_1076610-18996.jpg?semt=ais_hybrid&w=740"
                                alt="">
                            <div class="data-history">
                                <p class="titulo_params">Cuidado</p>
                                <p>Temperatura: 
                                < 10 °C ou> 20 °C</p>
                                <p> Umidade:
                                < 55% ou> 75%</p>
                            </div>
                        </div>


                    </div>
                </div>
            </div>
            <div class="column-2">
                <div class="grafico linha">
                    <h4 class="titulo_card titulo_desh">Variação na Temperatura nas Últimas 24h</h4>
                    <canvas id="variacao_temperatura_atual" style="width: 24vw; min-height: 30vh;"></canvas>
                </div>
                <div class="grafico linha">
                    <h4 class="titulo_card titulo_desh">Variação na Umidade nas Últimas 24h</h4>
                    <canvas id="variacao_umidade_atual" style="width: 24vw; min-height: 30vh;"></canvas>
                </div>
            </div>
        </div>

    </div>
    <div class="notificacoes" id="notificacao_caixa" style="display: none; z-index: 10;">
        <h4>Ultimas notificacoes <span><img src="../deshbord/imagens-deshbord/chevron-back-circle.png" alt=""
                    id="icone_fechar" onclick="fechar_notificacoes()"></span> </h4>
        <div class="notificacao">
            <img src="../deshbord/imagens-deshbord/notifications.png">
            <p>Armazém 1 <br> <span>Temperatura acima do
                    recomendado</span></p>
        </div>
        <div class="notificacao">
            <img src="../deshbord/imagens-deshbord/notifications.png">
            <p>Armazém 2<br> <span>Temperatura acima do
                    recomendado</span></p>
        </div>
        <div class="notificacao concluida">
            <img src="../deshbord/imagens-deshbord/notifications.png">
            <p>Armazém 3 <br><span>Temperatura acima do
                    recomendado</span></p>
        </div>
        <div class="notificacao concluida">
            <img src="../deshbord/imagens-deshbord/notifications.png">
            <p>Armazém 4 <br><span>Temperatura acima do
                    recomendado</span></p>
        </div>
        <div class="notificacao concluida">
            <img src="../deshbord/imagens-deshbord/notifications.png">
            <p>Armazém 5 <br><span>Temperatura acima do
                    recomendado</span></p>
        </div>
    </div>
</body>

</html>
<script>
    function validaressao() {
        var b_usuario = document.querySelectorAll(".b_usuario");
        var b_nome_fantasia = document.getElementById("b_nome_fantasia");
        var b_cargo = document.getElementById("b_cargo");

        if (nome != null || nomeFantasia != null || nomeCargo != null || fkUsuario != null ||
            email != null || telefone != null || fkVinicola != null || fkCargo != null || nomeCargo != null ||
            fkPermissao != null
        ) {
            console.log('fdsafsdafafda')
            b_usuario[0].innerHTML = nome;
            b_usuario[1].innerHTML = nome;
            b_nome_fantasia.innerHTML = nomeFantasia;
            b_cargo.innerHTML = nomeCargo;

        } else {
            alert("redicionamento")
            // window.location = "../login.html";
        }
    }

    // window.onload = validarSesso();

    let proximaAtualizacao
    const fkArmazem = 1;
    const b_temperatura_atual = document.getElementById('b_temperatura_atual')
    const b_umidade_atual = document.getElementById('b_umidade_atual')

    function trocar1() {
        var select = armazem_atual.value
        if (select == 'geral') {
            window.location.href = "deshbord.html";

        }

        if (select == 'armazem1') {
            window.location.href = "deshbord-armazem1.html";

        }
    }



    var notificacao_aberta = false
    // abrir as notificaoes
    function abrir_notificacoes() {
        if (notificacao_aberta == false) {
            notificacao_caixa.style = "display: 1 "
            notificacao_aberta = true
        } else {
            notificacao_caixa.style = "display: none "
            notificacao_aberta = false

        }


    }
    function fechar_notificacoes() {
        notificacao_caixa.style = "display:none"
    }
    //graficos com chart js
    // grafico do tipo barra

    window.onload = obterDadosGrafico(fkArmazem);
    function obterDadosGrafico(fkArmazem) {


        if (proximaAtualizacao != undefined) {
            clearTimeout(proximaAtualizacao);
        }

        fetch(`/medidas/ultimas/${fkArmazem}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    //      resposta.reverse();

                    plotarGrafico(resposta, fkArmazem);

                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }


    const ctx = document.getElementById('myChart');

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho'],
            datasets: [{
                label: 'Temperatura Média',
                data: [22, 24, 27, 23, 20, 18],
                backgroundColor: [
                    'rgb(255, 140, 0)',
                    'rgb(255, 140, 0)',
                    'rgb(255, 140, 0)',
                    'rgb(255, 140, 0)',
                    'rgb(255, 140, 0)',
                    'rgb(255, 140, 0)'
                ],
                borderWidth: 1
            },
            {
                label: 'Umidade Média',
                data: [90, 89, 93, 87, 88, 82],
                backgroundColor: [
                    'rgb(0, 102, 255)',
                    'rgb(0, 102, 255)',
                    'rgb(0, 102, 255)',
                    'rgb(0, 102, 255)',
                    'rgb(0, 102, 255)',
                    'rgb(0, 102, 255)'
                ],
                borderWidth: 1
            }
            ],
        },
    });

    const data_status_sensores = {
        labels: [
            'Ativo',
            'Inativo',
            'Em manutenção'
        ],
        datasets: [{
            label: 'status',
            data: [10, 0, 0],
            backgroundColor: [
                'rgb(158, 73, 99)', // Vermelho 
                'rgb(189, 115, 137)',  // Amarelo 
                '#4c1130', // Verde 
            ],
            radius: '95%',
            hoverOffset: 10
        }]
    };
    const donunts = {
        type: 'doughnut',
        data: data_status_sensores,
        options: {
            responsive: false,

            plugins: {
                legend: {
                    position: 'right', // Coloca a legenda embaixo do gráfico
                    labels: {
                        color: 'black', // Cor da fonte da legenda
                        font: {
                            size: 14
                        }
                    }
                },
            }
        }
    };
    const myChart_donuts = document.getElementById('status_sensores');
    new Chart(myChart_donuts, donunts);

    // grafico de ranking de alertas ativos por armazem -------------------------------------------------------------
    // grafico do tipo linha-------------------------------------------------------------

    function plotarGrafico(resposta, fkArmazem) {

        const label_temperatura = []
        const data_var_temp = {
            labels: label_temperatura,
            datasets: [{
                label: 'Temperatura',
                data: [],
                fill: false,
                borderColor: '#551c36',
                backgroundColor: '#551c36',
                tension: 0.1
            },
            ]
        };

        for (let i = resposta.length - 1; i >= 0; i--) {
            var registro = resposta[i];
            label_temperatura.push(registro.dataHora);
            data_var_temp.datasets[0].data.push(registro.temperatura);
            if (i == 0) {
                b_temperatura_atual.innerHTML = `${registro.temperatura} ° C`
            }
        }
        const config_var_temp = {
            type: 'line',
            data: data_var_temp,
        };
        const ctx_temp_atual = document.getElementById('variacao_temperatura_atual').getContext('2d');
        let GraficoTemperatura = new Chart(ctx_temp_atual, config_var_temp);

        const labels_umidade = []
        const data_var_umidade = {
            labels: labels_umidade,
            datasets: [{
                label: 'Umidade',
                data: [],
                fill: true,
                borderColor: 'rgba(240, 248, 255, 0)',
                backgroundColor: 'rgb(158, 73, 99',
                tension: 0.1
            },
            ]
        };
        for (let i = resposta.length - 1; i >= 0; i--) {
            var registro = resposta[i];
            labels_umidade.push(registro.dataHora);
            data_var_umidade.datasets[0].data.push(registro.umidade);
            if (i == 0) {
                b_umidade_atual.innerHTML = `${registro.umidade} %`
            }
        }
        const config_var_umidade = {
            type: 'line',
            data: data_var_umidade,
        };

        const ctx_umidade_atual = document.getElementById('variacao_umidade_atual').getContext('2d');
        let GraficoUmidade = new Chart(ctx_umidade_atual, config_var_umidade);




        setTimeout(() => {
            atualizar_grafico_temperatura(fkArmazem, data_var_temp, GraficoTemperatura, data_var_umidade, GraficoUmidade)
        }, 2000);

    }
    function atualizar_grafico_temperatura(fkArmazem, data_var_temp, GraficoTemperatura, data_var_umidade, GraficoUmidade) {



        fetch(`/medidas/tempo-real/${fkArmazem}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (novoRegistro) {

                    //  obterdados(fkArmazem);
                    // alertar(novoRegistro, fkArmazem);
                    console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
                    console.log(`Dados atuais do gráfico:`);
                    console.log(data_var_temp);


                    if (novoRegistro[0].dataHora == data_var_temp.labels[data_var_temp.labels.length - 1]) {
                        console.log("---------------------------------------------------------------")
                        console.log("Como não há data_var_temp novos para captura, o gráfico não atualizará.")
                        console.log("Horário do novo dado capturado:")
                        console.log(novoRegistro[0].dataHora)
                        console.log("Horário do último dado capturado:")
                        console.log(data_var_temp.labels[data_var_temp.labels.length - 1])
                        console.log("---------------------------------------------------------------")
                    } else {
                        // tirando e colocando valores no gráfico
                        data_var_temp.labels.shift(); // apagar o primeiro
                        data_var_temp.labels.push(novoRegistro[0].dataHora); // incluir um novo momento

                        data_var_temp.datasets[0].data.shift();  // apagar o primeiro de temperatura
                        data_var_temp.datasets[0].data.push(novoRegistro[0].temperatura); // incluir uma nova medida de temperatura
                        b_temperatura_atual.innerHTML = `${novoRegistro[0].temperatura} °C`
                        GraficoTemperatura.update();

                        data_var_umidade.labels.shift(); // apagar o primeiro
                        data_var_umidade.labels.push(novoRegistro[0].dataHora); // incluir um novo momento

                        data_var_umidade.datasets[0].data.shift();  // apagar o primeiro de temperatura
                        data_var_umidade.datasets[0].data.push(novoRegistro[0].umidade); // incluir uma nova medida de temperatura
                        b_umidade_atual.innerHTML = `${novoRegistro[0].umidade} %`

                        GraficoUmidade.update();


                    }

                    // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                    proximaAtualizacao = setTimeout(() => atualizar_grafico_temperatura(fkArmazem, data_var_temp, GraficoTemperatura, data_var_umidade, GraficoUmidade), 2000);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
                // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                proximaAtualizacao = setTimeout(() => atualizar_grafico_temperatura(fkArmazem, data_var_temp, GraficoTemperatura, data_var_umidade, GraficoUmidade), 2000);
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });

    }


</script>